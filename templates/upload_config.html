{% extends "base.html" %} {# Inherit from the base layout #}

{% block title %}Upload & Configure{% endblock %}

{% block head %}
    {# Add any page-specific CSS or meta tags here if needed #}
    <style>
        /* Additional styles specific to this page */
        .config-section { margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid #e5e7eb; /* gray-200 */ }
        .config-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .config-section h3 { margin-bottom: 1rem; font-size: 1.125rem; /* text-lg */ line-height: 1.75rem; font-weight: 500; color: #1f2937; /* gray-800 */ }
        .config-item { margin-bottom: 1rem; }
        .config-item label { display: block; margin-bottom: 0.25rem; font-weight: 500; color: #374151; /* gray-700 */ font-size: 0.875rem; /* text-sm */ }
        .config-item input[type=text], .config-item input[type=number], .config-item select {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            font-size: 0.875rem; /* text-sm */
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
        }
        .config-item input:focus, .config-item select:focus {
             border-color: #4f46e5; /* indigo-600 */
             box-shadow: 0 0 0 1px #4f46e5, inset 0 1px 2px rgba(0,0,0,0.05);
             outline: none;
        }
        .config-item p.help { font-size: 0.75rem; /* text-xs */ color: #6b7280; /* gray-500 */ margin-top: 0.25rem; }
        /* Styling for file list */
        .file-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e5e7eb;
        }
         .file-list-item:last-child {
            border-bottom: none;
         }
        .load-button {
             margin-left: 1rem;
             padding: 0.25rem 0.75rem; /* Smaller padding */
        }
    </style>
{% endblock %}

{% block navigation %}
    {# No specific navigation tabs needed on this page, rely on base if it has global nav #}
{% endblock %}


{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    {# --- Column 1: Upload & Process --- #}
    <div class="lg:col-span-1 bg-white p-6 shadow rounded-lg space-y-6">
        <div>
            <h2 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">1. Process New File</h2>
            {# Form submits the file to the backend processing route #}
            <form id="uploadForm" action="{{ url_for('processing.upload_original_file') }}" method="post" enctype="multipart/form-data">
                <div class="mb-4">
                    <label for="sourceExcelFile" class="block text-sm font-medium text-gray-700 mb-1">Select Source Excel File (.xlsx):</label>
                    <input type="file" id="sourceExcelFile" name="sourceExcelFile" required accept=".xlsx"
                           class="block w-full text-sm text-gray-500
                                  file:mr-4 file:py-2 file:px-4
                                  file:rounded-md file:border-0
                                  file:text-sm file:font-semibold
                                  file:bg-indigo-50 file:text-indigo-700
                                  hover:file:bg-indigo-100 cursor-pointer border border-gray-300 rounded-md p-1">
                    <p class="mt-1 text-xs text-gray-500">Upload the original Excel file for comparison.</p>
                </div>
                <div class="text-right">
                    {# Button now just uploads, processing is separate #}
                    <button type="submit" id="uploadButton"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md text-sm transition duration-150 ease-in-out">
                        Upload File
                    </button>
                </div>
            </form>
            {# Area to show upload status and trigger processing #}
            <div id="processingTriggerArea" class="mt-4 text-sm" style="display: none;">
                <p id="uploadSuccessMessage" class="text-green-700 mb-2"></p>
                <button id="runComparisonButton" onclick="runComparison()"
                        class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-md text-sm transition duration-150 ease-in-out">
                    Run Comparison & View Results
                </button>
                <p class="mt-2 text-xs text-gray-600">
                    This will compare the uploaded file with API data, generate a `*_processed.xlsx` file in the uploads folder, and load the results.
                </p>
            </div>
        </div>

        <hr>

        <div>
            <h2 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">2. Load Existing Processed File</h2>
            <p class="text-sm text-gray-600 mb-3">Select a previously processed file to view its results.</p>
            <div id="processedFilesList">
                {% if processed_files %}
                    <ul class="list-none max-h-60 overflow-y-auto border rounded-md p-2 bg-gray-50">
                        {% for filename in processed_files %}
                            <li class="file-list-item text-sm">
                                <span>{{ filename }}</span>
                                <button onclick="loadProcessedFile('{{ filename }}')"
                                        class="load-button bg-gray-500 hover:bg-gray-600 text-white font-medium py-1 px-3 rounded-md text-xs transition duration-150 ease-in-out">
                                    Load
                                </button>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-sm text-gray-500 italic">No processed files found in the 'uploads' directory.</p>
                {% endif %}
            </div>
             <div id="loadProcessedStatus" class="text-sm mt-2"></div>
        </div>
    </div>


    {# --- Column 2: Configuration Editing Section --- #}
    <div class="lg:col-span-2 bg-white p-6 shadow rounded-lg">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">Application Configuration</h2>
        <p class="text-sm text-gray-600 mb-4">
            Current settings loaded from <code>config.ini</code>. Modify values below and click "Save Configuration" to update the file.
            <br><strong class="text-red-600">Note:</strong> Changes typically require restarting the application or re-processing a file to take full effect.
        </p>
        {# Form submits updated config to the backend #}
        <form action="{{ url_for('processing.update_config') }}" method="post">
            {# --- API Section --- #}
            <div class="config-section">
                <h3 class="text-lg font-medium text-gray-700">API Endpoints</h3>
                 <div class="config-item">
                    <label for="config_dn_url">DN (VQ) URL:</label>
                    <input type="text" id="config_dn_url" name="dn_url" value="{{ config.get('dn_url', '') }}">
                 </div>
                 <div class="config-item">
                    <label for="config_agent_group_url">Agent Group (Skill/VAG/Expr) URL:</label>
                    <input type="text" id="config_agent_group_url" name="agent_group_url" value="{{ config.get('agent_group_url', '') }}">
                 </div>
                 <div class="config-item">
                    <label for="config_api_timeout">API Timeout (seconds):</label>
                    <input type="number" id="config_api_timeout" name="timeout" value="{{ config.get('api_timeout', 15) }}" min="1">
                 </div>
            </div>

             {# --- Sheet Layout Section --- #}
            <div class="config-section">
                 <h3 class="text-lg font-medium text-gray-700">Sheet Layout (for Processing)</h3>
                 <div class="config-item">
                    <label for="config_ideal_agent_header">Ideal Agent Header Text:</label>
                    <input type="text" id="config_ideal_agent_header" name="ideal_agent_header_text" value="{{ config.get('ideal_agent_header_text', '') }}">
                    <p class="help">Text to look for in Row 1 (Cols C/D) to find the Ideal Agent column during processing.</p>
                 </div>
                 <div class="config-item">
                    <label for="config_ideal_agent_fallback">Ideal Agent Fallback Cell:</label>
                    <input type="text" id="config_ideal_agent_fallback" name="ideal_agent_fallback_cell" value="{{ config.get('ideal_agent_fallback_cell', '') }}">
                     <p class="help">Cell coordinate (e.g., C2) to check if header text not found.</p>
                 </div>
                 <div class="config-item">
                    <label for="config_vag_sheet">VAG Extraction Sheet Name:</label>
                    <input type="text" id="config_vag_sheet" name="vag_extraction_sheet" value="{{ config.get('vag_extraction_sheet', '') }}">
                     <p class="help">Exact name of the sheet to extract VAGs from during processing.</p>
                 </div>
            </div>

            {# --- Files Section (Removed source_file) --- #}
            {# You could add other file-related settings here if needed in future #}
            {# <div class="config-section">
                <h3 class="text-lg font-medium text-gray-700">Files</h3>
            </div> #}


            <div class="text-right mt-4">
                <button type="submit"
                        class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-md text-sm transition duration-150 ease-in-out">
                    Save Configuration to config.ini
                </button>
            </div>
        </form>
    </div>

</div>
{% endblock %}


{% block action_bar %}
    {# No action bar needed on this page #}
{% endblock %}


{% block scripts %}
    {# --- Page-Specific JavaScript --- #}
    <script>
        const uploadForm = document.getElementById('uploadForm');
        const uploadButton = document.getElementById('uploadButton');
        const sourceExcelFile = document.getElementById('sourceExcelFile');
        const processingTriggerArea = document.getElementById('processingTriggerArea');
        const uploadSuccessMessage = document.getElementById('uploadSuccessMessage');
        const runComparisonButton = document.getElementById('runComparisonButton');
        const loadProcessedStatus = document.getElementById('loadProcessedStatus');
        const generalMessageArea = document.getElementById('generalMessageArea'); // For displaying flash messages or errors

        // --- Handle File Upload ---
        if (uploadForm) {
            uploadForm.addEventListener('submit', async (event) => {
                event.preventDefault(); // Prevent default form submission
                uploadButton.disabled = true;
                uploadButton.textContent = 'Uploading...';
                processingTriggerArea.style.display = 'none'; // Hide trigger area
                generalMessageArea.innerHTML = ''; // Clear previous messages

                const formData = new FormData(uploadForm);

                try {
                    const response = await fetch('{{ url_for("processing.upload_original_file") }}', {
                        method: 'POST',
                        body: formData,
                    });
                    const result = await response.json();

                    if (response.ok) {
                        uploadSuccessMessage.textContent = result.message || 'File uploaded.';
                        processingTriggerArea.style.display = 'block'; // Show button to run comparison
                        // Clear the file input? Optional.
                        // sourceExcelFile.value = '';
                    } else {
                        throw new Error(result.error || `Upload failed with status ${response.status}`);
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    // Display error in the general message area
                    generalMessageArea.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert"><strong class="font-bold">Upload Error:</strong> ${error.message}</div>`;
                } finally {
                    uploadButton.disabled = false;
                    uploadButton.textContent = 'Upload File';
                }
            });
        }

        // --- Trigger Comparison Run ---
        async function runComparison() {
            runComparisonButton.disabled = true;
            runComparisonButton.textContent = 'Processing... Please Wait...';
            generalMessageArea.innerHTML = `<div class="bg-blue-100 border border-blue-300 text-blue-700 px-4 py-3 rounded relative animate-pulse" role="alert">Running comparison and generating processed file... This may take a moment.</div>`;

            try {
                const response = await fetch('{{ url_for("processing.run_comparison") }}', {
                    method: 'POST', // No body needed, assumes last uploaded file
                });
                const result = await response.json();

                if (response.ok) {
                    generalMessageArea.innerHTML = `<div class="bg-green-100 border border-green-300 text-green-700 px-4 py-3 rounded relative" role="alert">${result.message || 'Processing complete.'} Redirecting...</div>`;
                    // Redirect to the results viewer page
                    window.location.href = result.redirect_url || '{{ url_for("ui.upload_config_page") }}';
                } else {
                     throw new Error(result.error || `Processing failed with status ${response.status}`);
                }

            } catch (error) {
                 console.error('Comparison run error:', error);
                 generalMessageArea.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert"><strong class="font-bold">Processing Error:</strong> ${error.message}. Check server logs.</div>`;
                 runComparisonButton.disabled = false; // Re-enable button on error
                 runComparisonButton.textContent = 'Run Comparison & View Results';
            }
        }

        // --- Load Existing Processed File ---
        async function loadProcessedFile(filename) {
            loadProcessedStatus.innerHTML = `<p class="text-blue-700 animate-pulse">Loading data from ${filename}...</p>`;
            generalMessageArea.innerHTML = ''; // Clear other messages

            try {
                 const response = await fetch('{{ url_for("processing.load_processed_file") }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: filename })
                });
                const result = await response.json();

                if (response.ok) {
                    loadProcessedStatus.innerHTML = `<p class="text-green-700">${result.message || 'Data loaded.'} Redirecting...</p>`;
                    // Redirect to the results viewer page
                    window.location.href = result.redirect_url || '{{ url_for("ui.upload_config_page") }}';
                } else {
                     throw new Error(result.error || `Loading failed with status ${response.status}`);
                }

            } catch (error) {
                 console.error('Error loading processed file:', error);
                 loadProcessedStatus.innerHTML = ''; // Clear loading message
                 generalMessageArea.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert"><strong class="font-bold">Load Error:</strong> ${error.message}. Check server logs.</div>`;
            }
        }

    </script>
{% endblock %}

